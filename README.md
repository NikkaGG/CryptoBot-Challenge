# Backend Auction Challenge — Аукционы подарков

Реализация **Telegram Gift Auctions–подобного** многораундового аукциона для лимитированных цифровых товаров.

Стек: **Node.js + TypeScript + MongoDB (transactions, replica set)**.

## Понимание продукта
Ключевые правила и допущения (в стиле Telegram Gift Auctions):

- Аукцион **многораундовый**: в каждом раунде часть участников получает товар, остальные продолжают участие.
- Ставка — **max-bid** (максимум, который вы готовы заплатить).
- Победители раунда платят не max-bid, а **единую проходную цену (cutoff)** — минимальную выигрышную ставку.
  Разница `maxBid - cutoff` автоматически возвращается.
- **Anti-sniping (soft-close)**: ставка в последние `antiSnipeWindowMs` продлевает раунд на `antiSnipeExtendMs`
  (но не дальше общего дедлайна `endsAt`, если задан `maxDurationMs`).
- Tie-break при равных ставках: 1) более ранний `lastBidAt`, 2) детерминированно по `userId`.
- Деньги: ставка резервирует только дельту (`available → reserved`), победа переводит `reserved → spent+available(refund)`.
- Конкурентность: все финоперации в MongoDB **transactions**, закрытие раунда идемпотентно (`open → closing` + `closingToken` + уникальные индексы).

Подробная спецификация: `docs/spec.md`.

## Что умеет сервис
- Многораундовый аукцион: в каждом раунде часть участников получает товар, остальные продолжают.
- Ставки как **max-bid** (максимум, который вы готовы отдать).
- **Единая проходная цена (cutoff)**: победители платят минимальную выигрышную ставку; разница возвращается.
- **Anti-sniping (soft-close)**: ставка в последние секунды продлевает раунд.
- Финансы: баланс `available/reserved/spent` + журнал операций (ledger).
- Веб-интерфейс для демо + управляемые боты.
- Нагрузочный скрипт + проверка инвариантов (деньги сходятся, serial уникальны и т.п.).

## Быстрый старт (рекомендуется): Docker
Требования: Docker Desktop / Docker Engine.

```bash
docker compose up --build
```

Открыть UI: **http://localhost:3000**

Остановить:
```bash
docker compose down
```

## Запуск без Docker
Важно: для транзакций Mongo нужен **replica set**.

```bash
npm install
npm run dev
```

Переменные окружения:
- `MONGO_URL` (по умолчанию `mongodb://localhost:27017/auction?replicaSet=rs0`)
- `PORT` (по умолчанию `3000`)
- `HOST` (по умолчанию `0.0.0.0`)

## Как пользоваться сервисом (через UI)
Откройте **http://localhost:3000**.

### 1) Создать пользователя и пополнить баланс
1. Нажмите **«Создать пользователя»**.
2. Введите сумму и нажмите **«Пополнить»**.
   - Баланс увеличится в `available`.

### 2) Создать и запустить аукцион
1. В блоке **«Создать аукцион»** задайте параметры:
   - **Количество** — сколько товаров раздать всего.
   - **Длительность раунда** — сколько длится один раунд.
   - **Победителей за раунд** — сколько пользователей получает товар в конце раунда.
   - **Anti-snipe** — окно и продление (soft-close).
   - **Макс. длительность / макс. пустых раундов** — защита от бесконечного аукциона.
2. Нажмите **«Создать»**.
3. В блоке **«Выбранный аукцион»** нажмите **«Старт»**.

### 3) Участвовать в аукционе (ставки)
1. Убедитесь, что выбран нужный аукцион.
2. Введите сумму в поле ставки и нажмите **«Сделать / повысить ставку»**.
   - При ставке деньги переходят из `available` в `reserved`.
   - Повышение ставки резервирует только разницу.

### 4) Боты (для “живого” аукциона и нагрузки)
В блоке ботов:
- Укажите количество ботов, баланс на бота и maxBid.
- Нажмите **«Запустить ботов»**.
- **«Статус ботов»** покажет, что они работают, и пример их ставок.
- **«Остановить ботов»** прекращает их работу.

### 5) Проверка корректности (инварианты)
- **«Проверить инварианты аукциона»** — сверяет сериалы, количество победителей, совпадение revenue со spend.
- **«Проверить глобальные инварианты»** — сверяет сохранение денег и соответствие `reserved` сумме активных ставок.

## API (если хотите дергать напрямую)
Все ответы в JSON.

### Health
- `GET /api/health`

### Пользователи
- `POST /api/users`
- `GET /api/users/:id`
- `POST /api/users/:id/topup` `{ "amount": 1000 }`

### Аукционы
- `POST /api/auctions` `{ title, totalQuantity, config? }`
- `GET /api/auctions`
- `GET /api/auctions/:id`
- `POST /api/auctions/:id/start`
- `POST /api/auctions/:id/cancel`
- `GET /api/auctions/:id/snapshot?userId=...`
- `POST /api/auctions/:id/bids` `{ "userId": "...", "amount": 123 }`
- `POST /api/auctions/:id/withdraw` `{ "userId": "..." }`

### Боты
- `GET /api/auctions/:id/bots`
- `POST /api/auctions/:id/bots/start` `{ "count": 50, "topupAmount": 5000, "maxBid": 5000 }`
- `POST /api/auctions/:id/bots/stop`

### Аудит
- `GET /api/audit`
- `GET /api/auctions/:id/audit`

Пример (Windows):
```powershell
curl.exe -s http://localhost:3000/api/health
```

## Нагрузочный прогон (CLI)
Поднимите сервис (Docker) и запустите:

```bash
npm run loadtest
```

Доступные переменные окружения для loadtest:
- `BASE_URL` (по умолчанию `http://localhost:3000`)
- `MONGO_URL` (по умолчанию `mongodb://localhost:27017/auction?replicaSet=rs0`)
- `USERS`, `TOPUP`, `QUANTITY`, `WINNERS_PER_ROUND`, `ROUND_MS`, `RUNTIME_LIMIT_MS`

Скрипт создаёт пользователей, делает ставки (включая “last-second”), ждёт завершения аукциона и проверяет инварианты через Mongo.
